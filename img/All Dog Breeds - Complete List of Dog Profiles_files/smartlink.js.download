let F2SmartLink={};function firePixel(t,e){let n=F2SmartLink.debug,r="//"+F2SmartLink.TRACK_ENDPOINT+"/api/tr?event="+t+"&eventInfo="+encodeURIComponent(JSON.stringify(e))+"&cb="+Date.now();document.createElement("IMG").src=r,n("firePixel(): eventName["+t+"]")}async function f2_initSmartLink(pubConfig){let debug=F2SmartLink.debug,dispatchEvent=F2SmartLink.dispatchEvent,normalizeUrl=F2SmartLink.normalizeUrl;async function swapTargets(t,e,n){let r=[];for(let e=0;e<t.length;e++){let n=t[e];if(n&&n.attributeValue){let t=F2SmartLink.getAbsoluteUrl(n.attributeValue);if(config.urlNormalizePattern&&(t=F2SmartLink.normalizeUrlByPattern(t,config.urlNormalizePattern,config.urlNormalizePlaceHolder)),"function"==typeof window.f2_smartlink_customizedUrl){let e=window.f2_smartlink_customizedUrl(t,config.setting);e&&(r=r.concat(e),debug("Customized url from ["+t+"] to ["+e+"]"))}else r.push(t)}}r=F2SmartLink.dedup(r);let i=F2SmartLink.getRootDomainByUrl(location.href),a=config.uuidApiUrlTpl.replace(/\{sid\}/g,config.sid).replace(/\{said\}/g,i).replace(/\{page_url\}/g,encodeURIComponent(location.href)).replace(/\{impression_id\}/g,config.impressionId);F2SmartLink.debugEnable()&&(a+="&f2debug=1"),n&&(a+="&collect_link_only=1");try{let n=await F2SmartLink.httpPost(a,JSON.stringify(r)),o={};try{o=JSON.parse(n)}catch(t){return void debug("Error: Get uuid map failed.")}let l=[];for(let t in o)"SMARTLINK_NOT_FOUND"===o[t]&&l.push(t);if(l.length>0){debug("Got ["+l.length+"] urls don't have UUID, so call backend to generate them");let t=config.createUuidApiUrlTpl.replace(/\{sid\}/g,config.sid).replace(/\{said\}/g,i).replace(/\{page_url\}/g,encodeURIComponent(location.href)).replace(/\{impression_id\}/g,config.impressionId);F2SmartLink.httpPost(t,JSON.stringify(l))}else debug("No urls has no UUID");for(let t in o)F2SmartLink.isValidLinkId(o[t])||delete o[t];let c=[];for(let n=0;n<t.length;n++){let r=t[n];if(!r||!r.attributeValue)continue;let i=F2SmartLink.getAbsoluteUrl(r.attributeValue),a=i;config.urlNormalizePattern&&(a=F2SmartLink.normalizeUrlByPattern(i,config.urlNormalizePattern,config.urlNormalizePlaceHolder));let l=null;if("function"==typeof window.f2_smartlink_customizedUrl){let t=window.f2_smartlink_customizedUrl(a,config.setting);if(t){l=t.map(t=>o[t]).filter(t=>!!t)[0],debug("Customized urls from ["+url+"] to ["+t+"] and matched uuid["+l+"]")}}else l=o[a];if(!l){debug("Error: Failed to fetch UUID["+l+"] for url["+a+"], so do not change the link");continue}let u=config.linkTpl.replace("{uuid}",l).replace(/\{impression_id\}/g,config.impressionId).replace(/\{original_url\}/g,encodeURIComponent(i)).replace(/\{page_url\}/g,encodeURIComponent(location.href));(e?overrideElement(r,l,u):swapLink(r,l,u))&&c.push(r)}debug(c.length+" urls are swapped."),dispatchEvent("f2-smartlink-targets-swapped",{detail:c}),"function"==typeof window.f2_smartlink_afterSwap&&(window.f2_smartlink_afterSwap(c,config.setting),debug("Run window.f2_smartlink_afterSwap() on ["+c.length+"] swapped targets."))}catch(t){debug("Error: call link api failed. Error - "+t)}}function overrideElement(t,e,n){let r=F2SmartLink.unbindEvents(t.element);t.element=r;let i=r.querySelectorAll("a");for(let t=0;t<i.length;t++)F2SmartLink.addListener(i[t],"click",function(t){return t.stopPropagation(),t.preventDefault(),!1});return F2SmartLink.addListener(r,"click",function(e){e.stopPropagation(),e.preventDefault();let r=F2SmartLink.createUUID(),i=n.replace("{click_id}",r);return debug("Clicked url["+i+"], original link["+t.attributeValue+"]"),window.open(i,"_blank"),!1},!1),!0}function swapLink(t,e,n){return t.element.setAttribute(t.attributeName,n),F2SmartLink.addListener(t.element,"click",function(e){let r=F2SmartLink.createUUID(),i=n.replace("{click_id}",r);t.element.setAttribute(t.attributeName,i)},!1),!0}async function getSettingBySid(t){let e=config.configUrlTpl.replace("{sid}",t),n=await F2SmartLink.loadResource(e);if(!n)return debug("Can not load page config from ["+e+"]."),null;try{return JSON.parse(n).smartlinkSetting}catch(t){return debug("Error: fetch publisherConfig from ["+e+"] failed. Error - "+t),null}}async function start(){let targetSelector=config.targetSelector,targetAttribute=config.targetAttribute,productUrlPattern=config.productUrlPattern;config.customJs&&(eval(config.customJs),debug("Executed custom JS code"));let targets=F2SmartLink.matchTargets(targetSelector,targetAttribute,productUrlPattern);debug("Matched ["+targets.length+"] targets");let filteredTargets=F2SmartLink.checkTrafficAndFilter(document.referrer,targets,config);if(debug("Targets count ["+targets.length+"] before traffic check and ["+filteredTargets.length+"] after."),targets=filteredTargets,!targets||0===targets.length)return void debug("No targets to swap");"function"==typeof window.f2_smartlink_filterTargets&&(debug("["+targets.length+"] targets before running window.f2_smartlink_filterTargets()"),targets=window.f2_smartlink_filterTargets(targets,config.setting),debug("["+targets.length+"] targets after running window.f2_smartlink_filterTargets()"));let isOverrideEvent="1"===config.targetEventsOverride||1===config.targetEventsOverride||"true"===config.targetEventsOverride||!0===config.targetEventsOverride,isCollectLinkOnly="1"===config.collectLinkOnly;await swapTargets(targets,isOverrideEvent,isCollectLinkOnly)}debug("smartlink/js/smartlink.js is loaded.");let defaultConfig={uuidApiUrlTpl:F2SmartLink.API_ENDPOINT+"/api/links?sid={sid}&page_url={page_url}&impid={impression_id}",createUuidApiUrlTpl:F2SmartLink.API_ENDPOINT+"/api/links/create?sid={sid}&page_url={page_url}&impid={impression_id}",linkTpl:F2SmartLink.CLICK_ENDPOINT+"/p/{uuid}?impid={impression_id}&ou={original_url}&pu={page_url}",configUrlTpl:F2SmartLink.CDN_ENDPOINT+"/config/{sid}.json?cb="+Date.now(),impressionId:F2SmartLink.createUUID()},config=F2SmartLink.extend({},defaultConfig,pubConfig);if(config.setting||(debug("Setting not passed in, so load by SID["+config.sid+"]"),config.setting=await getSettingBySid(config.sid),debug("Loaded setting by SID["+config.sid+"]")),!config.setting)return void debug("No setting, so stop.");if(config=F2SmartLink.extend(config,config.setting),!F2SmartLink.isPageWhitelisted(location.href,config.urlPrefixWhitelist,config.urlPrefixBlacklist))return void debug("The current page didn't pass whitelist check. page["+location.href+"], urlPrefixWhitelist["+config.urlPrefixWhitelist+"], urlPrefixBlacklist["+config.urlPrefixBlacklist+"]");if(!F2SmartLink.shouldSwapByPercent(location.href,config.pageSwapPercentMap,Math.floor(100*Math.random())))return void debug("The current page didn't pass swap percent. page["+location.href+"], pageSwapPercentMap["+JSON.stringify(config.pageSwapPercentMap)+"]");let eventInfo={sid:config.sid,said:F2SmartLink.getRootDomainByUrl(location.href),external_referrer:document.referrer,source_url:location.href,js_version:F2SmartLink.js_version,uuid:config.impressionId,product:"smartlink"};firePixel("impression",eventInfo),start()}F2SmartLink.js_version="20220422",F2SmartLink.ROOT_DOMAIN="searchiq.co",F2SmartLink.TRACK_ENDPOINT="t2."+F2SmartLink.ROOT_DOMAIN,F2SmartLink.API_ENDPOINT="//api.next2.io",F2SmartLink.CLICK_ENDPOINT="//c.next2.io",F2SmartLink.CDN_ENDPOINT="//cdn.next2.io",F2SmartLink.timestamp=function(){let t=new Date;return t.getFullYear()+"-"+(t.getMonth()+1)+"-"+t.getDate()+"T"+t.getHours()+":"+t.getMinutes()+":"+t.getSeconds()+"."+t.getMilliseconds()},F2SmartLink.debugEnable=function(){return location.href.indexOf("f2debug=1")>-1||document.cookie.indexOf("f2debug=1")>-1},F2SmartLink.debug=function(t){let e=F2SmartLink.timestamp;F2SmartLink.debugEnable()&&"undefined"!=typeof console&&console.log&&console.log("["+e()+"] smartlink.js:"+t)},F2SmartLink.normalizeUrl=function(t){return t.replace(/^http[s]?:\/\//,"").replace(/^www\./g,"").replace(/\?.*/g,"").replace(/#.*/g,"").replace(/\/$/,"").replace(/\//g,"_")},F2SmartLink.normalizeUrlByPattern=function(t,e,n){return n||(n=""),t.replace(new RegExp(e,"g"),n)},F2SmartLink.hash=function(t){function e(t,e){var n=r(n=t[0],u=t[1],c=t[2],l=t[3],e[0],7,-680876936),l=r(l,n,u,c,e[1],12,-389564586),c=r(c,l,n,u,e[2],17,606105819),u=r(u,c,l,n,e[3],22,-1044525330);n=o(n=a(n=a(n=a(n=a(n=i(n=i(n=i(n=i(n=r(n=r(n=r(n,u,c,l,e[4],7,-176418897),u=r(u,c=r(c,l=r(l,n,u,c,e[5],12,1200080426),n,u,e[6],17,-1473231341),l,n,e[7],22,-45705983),c,l,e[8],7,1770035416),u=r(u,c=r(c,l=r(l,n,u,c,e[9],12,-1958414417),n,u,e[10],17,-42063),l,n,e[11],22,-1990404162),c,l,e[12],7,1804603682),u=r(u,c=r(c,l=r(l,n,u,c,e[13],12,-40341101),n,u,e[14],17,-1502002290),l,n,e[15],22,1236535329),c,l,e[1],5,-165796510),u=i(u,c=i(c,l=i(l,n,u,c,e[6],9,-1069501632),n,u,e[11],14,643717713),l,n,e[0],20,-373897302),c,l,e[5],5,-701558691),u=i(u,c=i(c,l=i(l,n,u,c,e[10],9,38016083),n,u,e[15],14,-660478335),l,n,e[4],20,-405537848),c,l,e[9],5,568446438),u=i(u,c=i(c,l=i(l,n,u,c,e[14],9,-1019803690),n,u,e[3],14,-187363961),l,n,e[8],20,1163531501),c,l,e[13],5,-1444681467),u=i(u,c=i(c,l=i(l,n,u,c,e[2],9,-51403784),n,u,e[7],14,1735328473),l,n,e[12],20,-1926607734),c,l,e[5],4,-378558),u=a(u,c=a(c,l=a(l,n,u,c,e[8],11,-2022574463),n,u,e[11],16,1839030562),l,n,e[14],23,-35309556),c,l,e[1],4,-1530992060),u=a(u,c=a(c,l=a(l,n,u,c,e[4],11,1272893353),n,u,e[7],16,-155497632),l,n,e[10],23,-1094730640),c,l,e[13],4,681279174),u=a(u,c=a(c,l=a(l,n,u,c,e[0],11,-358537222),n,u,e[3],16,-722521979),l,n,e[6],23,76029189),c,l,e[9],4,-640364487),u=a(u,c=a(c,l=a(l,n,u,c,e[12],11,-421815835),n,u,e[15],16,530742520),l,n,e[2],23,-995338651),c,l,e[0],6,-198630844),u=o(u=o(u=o(u=o(u,c=o(c,l=o(l,n,u,c,e[7],10,1126891415),n,u,e[14],15,-1416354905),l,n,e[5],21,-57434055),c=o(c,l=o(l,n=o(n,u,c,l,e[12],6,1700485571),u,c,e[3],10,-1894986606),n,u,e[10],15,-1051523),l,n,e[1],21,-2054922799),c=o(c,l=o(l,n=o(n,u,c,l,e[8],6,1873313359),u,c,e[15],10,-30611744),n,u,e[6],15,-1560198380),l,n,e[13],21,1309151649),c=o(c,l=o(l,n=o(n,u,c,l,e[4],6,-145523070),u,c,e[11],10,-1120210379),n,u,e[2],15,718787259),l,n,e[9],21,-343485551),t[0]=s(n,t[0]),t[1]=s(u,t[1]),t[2]=s(c,t[2]),t[3]=s(l,t[3])}function n(t,e,n,r,i,a){return s((e=s(s(e,t),s(r,a)))<<i|e>>>32-i,n)}function r(t,e,r,i,a,o,l){return n(e&r|~e&i,t,e,a,o,l)}function i(t,e,r,i,a,o,l){return n(e&i|r&~i,t,e,a,o,l)}function a(t,e,r,i,a,o,l){return n(e^r^i,t,e,a,o,l)}function o(t,e,r,i,a,o,l){return n(r^(e|~i),t,e,a,o,l)}function l(t){for(var e=[],n=0;n<64;n+=4)e[n>>2]=t.charCodeAt(n)+(t.charCodeAt(n+1)<<8)+(t.charCodeAt(n+2)<<16)+(t.charCodeAt(n+3)<<24);return e}var c="0123456789abcdef".split("");function u(t){for(var e="",n=0;n<4;n++)e+=c[t>>8*n+4&15]+c[t>>8*n&15];return e}function s(t,e){return t+e&4294967295}return function(t){for(var e=0;e<t.length;e++)t[e]=u(t[e]);return t.join("")}(function(t){txt="";for(var n=t.length,r=[1732584193,-271733879,-1732584194,271733878],i=64;i<=t.length;i+=64)e(r,l(t.substring(i-64,i)));t=t.substring(i-64);var a=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(i=0;i<t.length;i++)a[i>>2]|=t.charCodeAt(i)<<(i%4<<3);if(a[i>>2]|=128<<(i%4<<3),55<i)for(e(r,a),i=0;i<16;i++)a[i]=0;return a[14]=8*n,e(r,a),r}(t))},F2SmartLink.createUUID=function(){let t=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){let n=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"==e?n:3&n|8).toString(16)})},F2SmartLink.getAttributeNamesByUrlPattern=function(t,e){F2SmartLink.debug;let n=t.attributes,r=[];for(let t=0;t<n.length;t++){let i=n[t];i.value&&i.value.match(e)&&r.push(i.name)}return r},F2SmartLink.splitText=function(t,e){let n=t.split(e),r=[];for(let t=0;t<n.length;t++)n[t]=n[t].trim(),n[t]&&r.push(n[t]);return r},F2SmartLink.matchTargets=function(t,e,n){let r=F2SmartLink.debug;t||(t="*",r("no targetCssSelector passed in, so use *")),n||(n=".*",r("no urlRegex passed in, so use '.*'")),e||(e="");let i=Date.now(),a=[],o=document.querySelectorAll(t);for(let t=0;t<o.length;t++){let r=F2SmartLink.splitText(e,","),i=o[t];if(r&&0!==r.length||(r=F2SmartLink.getAttributeNamesByUrlPattern(i,n)),r&&r.length>0)for(let t=0;t<r.length;t++){let e=r[t],o=i.getAttribute(e);if(o&&o.match(n)){if(".*"===n&&-1===o.indexOf("/"))continue;a.push({element:i,attributeName:e,attributeValue:o})}}}return r("Url matching took "+(Date.now()-i)+"ms, got "+a.length+" targets"),a},F2SmartLink.getRootDomainByUrl=function(t){let e=document.createElement("A");return e.href=t,F2SmartLink.getRootDomain(e.hostname)},F2SmartLink.getRootDomain=function(t){if(!t)return"";let e=t.split(".");return e.length<2?t:e.length>2&&t.match(/(.co.uk|.net.uk|.org.uk|.gov.uk|.com.au|.net.au|.edu.au|.gov.au|.com.cn|.net.cn|.edu.cn|.gov.cn)$/)?e[e.length-3]+"."+e[e.length-2]+"."+e[e.length-1]:e[e.length-2]+"."+e[e.length-1]},F2SmartLink.extend=function(t){for(let t=1;t<arguments.length;t++)for(let e in arguments[t])arguments[t].hasOwnProperty(e)&&(arguments[0][e]=arguments[t][e]);return arguments[0]},F2SmartLink.unbindEvents=function(t){let e=t.cloneNode(!0);return t.parentNode.replaceChild(e,t),e},F2SmartLink.addListener=function(t,e,n){t.addEventListener?t.addEventListener(e,n,!1):t.attachEvent?t.attachEvent("on"+e,n):t["on"+e]=n},F2SmartLink.getAbsoluteUrl=function(){let t;return function(e){return t||(t=document.createElement("a")),t.href=e,t.href}}(),F2SmartLink.dispatchEvent=function(t,e){let n=F2SmartLink.debug,r=new CustomEvent(t,e);document.dispatchEvent(r),n("Dispatched custom event["+t+"] on document")},F2SmartLink.dedup=function(t){return t.reduce(function(t,e){return t.indexOf(e)<0&&t.push(e),t},[])},F2SmartLink.isValidLinkId=function(t){return!!t&&!!t.match(/^[0-9a-z]+$/g)},F2SmartLink.httpCall=async function(t,e,n,r){return new Promise((i,a)=>{r=!!r;let o=new XMLHttpRequest;o.withCredentials=r,o.open(t,e,!0),o.send(n),o.onreadystatechange=function(){o.readyState==XMLHttpRequest.DONE&&(o.status>=200&&o.status<400?i(o.responseText):a("Http response status is ["+o.status+"]"))},o.onerror=function(t){a("Http call to url["+e+"] failed. xhr.status="+o.status+". Error - "+JSON.stringify(t))}})},F2SmartLink.httpGet=async function(t,e){return F2SmartLink.httpCall("GET",t,null,e)},F2SmartLink.httpPost=async function(t,e,n){return F2SmartLink.httpCall("POST",t,e,n)},F2SmartLink.loadResource=async function(t){return(await F2SmartLink.loadResources([t]))[t]},F2SmartLink.loadResources=async function(t,e){let n=F2SmartLink.debug;return new Promise((r,i)=>{e=e||30;let a={};for(let e=0;e<t.length;e++)!async function(){let r=t[e],i=r.indexOf("/api/connect")>-1;try{a[r]=await F2SmartLink.httpGet(r,i)}catch(t){a[r]=null;let e="Error: Fetch resource["+r+"] failed. Error - "+err;n(e)}}();let o=setInterval(function(){Object.keys(a).length===t.length&&(clearInterval(o),clearTimeout(l),r(a))},100),l=setTimeout(function(){n("Warn: Timeout to load resource for urls["+t+"]"),clearInterval(o),r(a)},1e3*e)})},F2SmartLink.checkTrafficAndFilter=function(t,e,n){let r=F2SmartLink.debug;if(!n.f2TrafficPattern&&!n.linkPatternToSwapOnTheirTraffic)return e;if(n.f2TrafficPattern&&!!t.match(n.f2TrafficPattern))return e;if(!n.linkPatternToSwapOnTheirTraffic)return[];let i=e.filter(t=>t.attributeValue.match(n.linkPatternToSwapOnTheirTraffic));return r("Filtered targets by traffic. f2TrafficPattern["+n.f2TrafficPattern+"], linkPatternToSwapOnTheirTraffic["+n.linkPatternToSwapOnTheirTraffic+"]"),i},F2SmartLink.cloneObj=function(t){return t?JSON.parse(JSON.stringify(t)):{}},F2SmartLink.urlPrefixMatch=function(t,e){if(!e||!t)return null;for(let n=0;n<t.length;n++){let r=F2SmartLink.normalizeUrl(e),i=F2SmartLink.normalizeUrl(t[n]);if(0===r.indexOf(i))return t[n]}return null},F2SmartLink.isPageWhitelisted=function(t,e,n){let r=F2SmartLink.debug;if(!t)return!1;if(e&&e.length>0){let n=F2SmartLink.urlPrefixMatch(e,t);if(!n)return r("No matched whitelist prefix for pageUrl["+t+"]"),!1;r("Matched whitelist prefix["+n+"] for pageUrl["+t+"]")}else r("No urlPrefixWhitelist.");if(n&&n.length>0){let e=F2SmartLink.urlPrefixMatch(n,t);if(e)return r("Matched blacklist prefix["+e+"] for pageUrl["+t+"]"),!1;r("No matched blacklist prefix for pageUrl["+t+"]")}else r("No urlPrefixBlacklist.");return r("Page url["+t+"] is whitelisted"),!0},F2SmartLink.shouldSwapByPercent=function(t,e,n){let r=F2SmartLink.debug;if(!e)return r("No swap percent map, so continue ..."),!0;let i={};for(let t in e)i[F2SmartLink.normalizeUrl(t)]=e[t];let a=null,o=F2SmartLink.normalizeUrl(t);for(let t in i)if(0===o.indexOf(t)){r("Swap percent found with prefix["+t+"] matched"),a=i[t];break}return null==a?(r("No swap percent found, so continue swapping."),!0):(r("Swap percent check: percent["+a+"], rand["+n+"]"),n<a?(r("Page passed percent check for swapping"),!0):(r("Page didn't pass percent check for swapping"),!1))},window.f2SmartlinkConfig&&(F2SmartLink.debug("window.f2SmartlinkConfig exist, so load it"),f2_initSmartLink(window.f2SmartlinkConfig));